namespace: FieldServicesMonthlyTrainingReports
operation:
  name: ValidateReport
  inputs:
    - completedReportName
    - fileLocation
    - groupSplits
    - accesstoken
  python_action:
    use_jython: false
    script: "def execute(completedReportName,fileLocation,groupSplits,accesstoken):\n    from openpyxl import load_workbook\n    import requests\n    \n    groupSplitWB = load_workbook(filename=groupSplits,read_only=True)\n    groupSplitWS = groupSplitWB.active\n    rowCount = groupSplitWS.max_row + 1\n    \n    for row in range(1,rowCount):\n        reportName = groupSplitWS[\"A\"+str(row)].value\n        if reportName in completedReportName:\n            managerName = groupSplitWS[\"D\"+str(row)].value\n            organisationName = groupSplitWS[\"E\"+str(row)].value\n            fsGroup = groupSplitWS[\"I\"+str(row)].value\n            break   \n    groupSplitWB.close()\n    \n    if organisationName != \"||\":\n        filterCheck = organisationName\n        tempFilterCheck = organisationName.split(\"|\")\n        colCheck = \"B\"\n    else:\n        filterCheck = managerName\n        tempFilterCheck = managerName.split(\"|\")\n        colCheck = \"A\"\n    \n    filterLen = len(tempFilterCheck)\n    filterFound = []\n    \n    sheetNames = [\"Certification\",\"Curricula\"]\n    \n    completedReportWB = load_workbook(filename=fileLocation+completedReportName,read_only=False)\n    completedReportWS = completedReportWB.active\n    row = completedReportWS.max_row + 1\n    \n    for r in range(1,row):\n        fieldCheck = completedReportWS[colCheck+str(r)].value\n        if str(fieldCheck) in filterCheck:\n            if fieldCheck not in filterFound:\n                filterFound.append(fieldCheck)\n    \n    filterFoundLen = len(filterFound)\n    \n    expectedFilter = '\\n'.join(str(x) for x in tempFilterCheck)\n    foundFilter = '\\n'.join(str(x) for x in filterFound)\n    \n    if filterLen != filterFoundLen:\n        if fsGroup == \"Regional\":\n            name = \"Maddie\"\n            address = \"Maddie.Reynolds@sapowernetworks.com.au\"\n        if fsGroup == \"Metro Ops\":\n            name = \"Kaitlyn\"\n            address = \"Kaitlyn.Kotaras@sapowernetworks.com.au\"\n        if fsGroup == \"Metropolitan\":\n            name = \"Issy\"\n            address = \"Isabell.AlNahat@sapowernetworks.com.au\"\n            \n        if name == \"Maddie\":\n            body = f\"Hi {name},\\n\\nThe report '{reportName}' has failed it's filter validation check.\\n\\nThe filters expected were:\\n{expectedFilter}\\n\\nThe filters found were:\\n{foundFilter}\\n\\nIf there are unexpected issues, please reach out to the IT Automation Team\\n\\nThe report has been uploaded.\\n\\nThanks\"        \n            url = \"https://graph.microsoft.com/v1.0/users/svcrpabot@sapowernetworks.com.au/sendMail\"\n            payload = \"{\\r\\n  \\\"message\\\": {\\r\\n    \\\"subject\\\": \\\"FS Monthly Training Reports Automation\\\",\\r\\n    \\\"body\\\": {\\r\\n      \\\"contentType\\\": \\\"Text\\\",\\r\\n      \\\"content\\\": \\\"\"+body+\"\\\"\\r\\n    },\\r\\n    \\\"toRecipients\\\": [\\r\\n      {\\r\\n        \\\"emailAddress\\\": {\\r\\n          \\\"address\\\": \\\"\"+address+\"\\\"\\r\\n        }\\r\\n      }\\r\\n    ],\\r\\n    \\\"ccRecipients\\\": [\\r\\n      {\\r\\n        \\\"emailAddress\\\": {\\r\\n          \\\"address\\\": \\\"jasmin.haas@sapowernetworks.com.au\\\"\\r\\n        }\\r\\n      }\\r\\n    ]\\r\\n  },\\r\\n  \\\"saveToSentItems\\\": \\\"true\\\"\\r\\n}\"\n            headers = {\n                'Content-Type': 'application/json',\n                'SdkVersion': 'postman-graph/v1.0',\n                'Authorization': 'Bearer '+ accesstoken\n            }\n            response = requests.request(\"POST\", url, headers=headers, data = payload)\n        \n    ws = completedReportWB[sheetNames[0]] \n    ws.delete_cols(2, 1) \n    ws = completedReportWB[sheetNames[1]] \n    ws.delete_cols(2, 1) \n        \n    completedReportWB.save(fileLocation+completedReportName)\n    completedReportWB.close()"
  results:
    - SUCCESS
