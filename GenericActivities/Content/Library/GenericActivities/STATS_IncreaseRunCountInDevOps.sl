########################################################################################################################
#!!
#! @input EpicWorkItemID: The work item ID of the Epic in LCAT devops
#!!#
########################################################################################################################
namespace: GenericActivities
operation:
  name: STATS_IncreaseRunCountInDevOps
  inputs:
    - EpicWorkItemID
  python_action:
    use_jython: false
    script: "def execute(EpicWorkItemID):\n    global pd, date, timedelta, wincom32Client, os, root\n    import win32com.client as wincom32Client\n    import os\n    from datetime import date, timedelta\n    import pandas as pd    \n    import requests\n    import json\n    \n    url = \"https://prod-21.australiasoutheast.logic.azure.com:443/workflows/b59cd7239c9b43e2b856113b41d7d78b/triggers/manual/paths/invoke?api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=5zL_aywdrip-YPvltxO5FVjMsmv5m2gwsfHc9FHoeqg\"\n    \n    payload = json.dumps({\n      \"workItemID\": int(EpicWorkItemID)\n    })\n    headers = {\n      'Content-Type': 'application/json'\n    }\n    \n    response = requests.request(\"POST\", url, headers=headers, data=payload)\n    \n    if not (response.status_code >= 200 and response.status_code < 300):\n        to = \"dl_itautomationteam@sapowernetworks.com.au\"\n        subject = \"Azure DevOps Run Increase Failure - Work Item ID: \" + EpicWorkItemID\n        body = f\"Hi,<br><br>The work item ID {EpicWorkItemID} failed to increase the run count in Azure DevOps:<br><br>Result: {response.status_code} - {response.reason} {response.text}<br><br>Thanks\"\n        attachments = \"\"\n        sendEmail(to, subject, body, attachments)\n    elif response.status_code >= 200 and response.status_code < 300:\n        if response.text != \"Successfully increased run stat in DevOps\":\n            to = \"dl_itautomationteam@sapowernetworks.com.au\"\n            subject = \"Azure DevOps Run Increase Failure - Work Item ID: \" + EpicWorkItemID\n            body = f\"Hi,<br><br>The work item ID {EpicWorkItemID} failed to increase the run count in Azure DevOps:<br><br>Result: {response.status_code} - {response.reason} {response.text}<br><br>Thanks\"\n            attachments = \"\"\n            sendEmail(to, subject, body, attachments)\n\ndef sendEmail(to, subject, HTMLbody, files):\n\t\n    iConf = wincom32Client.Dispatch(\"CDO.Configuration\")\n    Flds = iConf.Fields\n    Flds(\"http://schemas.microsoft.com/cdo/configuration/smtpserver\").Value = \"emanager\"\n    Flds(\"http://schemas.microsoft.com/cdo/configuration/smtpserverport\").Value = 25\n    Flds(\"http://schemas.microsoft.com/cdo/configuration/sendusing\").Value = 2\n    Flds('http://schemas.microsoft.com/cdo/configuration/smtpauthenticate').Value = 0\n    Flds.Update()\n    emailAddresses = to.split(\",\")\n    iMsg = wincom32Client.Dispatch(\"CDO.Message\")\n    iMsg.Configuration = iConf\n    iMsg.To = \";\".join(emailAddresses)\n    iMsg.From = \"Process_Automation@sapowernetworks.com.au\"\n    iMsg.Subject = subject\n    iMsg.HTMLBody = HTMLbody\n    files = files.split(\",\")\n    for file in files:\n        iMsg.AddAttachment(file)\n    iMsg.Send()"
  results:
    - SUCCESS
