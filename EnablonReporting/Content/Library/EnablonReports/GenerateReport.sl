namespace: EnablonReports
operation:
  name: GenerateReport
  inputs:
    - firstWorkbookName
    - firstSheetName
    - secondWorkbookName:
        required: false
    - secondSheetName:
        required: false
    - reportLocation
    - reportName
  python_action:
    use_jython: false
    script: "def execute(reportLocation,reportName,firstSheetName,firstWorkbookName,secondSheetName,secondWorkbookName):\n    from openpyxl import load_workbook\n    from openpyxl.styles import PatternFill\n    from datetime import datetime\n\n    #open the Enablon Reports\n    firstWorkbook = load_workbook(filename=reportLocation+firstWorkbookName,read_only=False)\n    firstWorksheet = firstWorkbook.active\n    firstRowCount = firstWorksheet.max_row + 1\n    \n    if secondWorkbookName != \"\":\n        secondWorkbook = load_workbook(filename=reportLocation+secondWorkbookName,read_only=False)\n        secondWorksheet = secondWorkbook.active\n        secondRowCount = secondWorksheet.max_row + 1\n    \n    #open the formatted report and get all sheets\n    formattedWorkbook = load_workbook(filename=reportLocation+reportName,read_only=False)\n    combinedWorksheet = formattedWorkbook[\"Field Services Combined Workpla\"]\n    combinedRowCount = combinedWorksheet.max_row + 1\n    combinedStartingRow = 18\n    \n    formattedSheet1 = formattedWorkbook[firstSheetName]\n    formattedSheet1Count = formattedSheet1.max_row + 1\n    formattedStartingRow = 2\n    \n    if secondWorkbookName != \"\":\n        formattedSheet2 = formattedWorkbook[secondSheetName]\n        formattedSheet2Count = formattedSheet2.max_row + 1\n    \n    #extract first enablon report\n    x = combinedStartingRow\n    y = formattedStartingRow\n    for row in range(4,firstRowCount):\n        if firstWorksheet[\"Q\"+str(row)].value != None:\n            manager = firstWorksheet[\"Q\"+str(row)].value\n            workGroup = firstWorksheet[\"B\"+str(row)].value\n            inspectionType = firstWorksheet[\"E\"+str(row)].value\n            title = firstWorksheet[\"D\"+str(row)].value\n            startDate = firstWorksheet[\"F\"+str(row)].value\n            dueDate = firstWorksheet[\"G\"+str(row)].value\n            owner = firstWorksheet[\"H\"+str(row)].value\n            percentDone = firstWorksheet[\"L\"+str(row)].value\n            status = firstWorksheet[\"K\"+str(row)].value\n            cancellation = firstWorksheet[\"R\"+str(row)].value\n            if workGroup.find(\"OBSOLETE\") > 0:\n                workGroup = workGroup.replace(\"OBSOLETE \", \"\")    \n            if status == \"Completed\":\n                #green\n                statusColour = \"21C452\"\n            elif status == \"Overdue\":\n                #red\n                statusColour = \"DE211B\"\n            elif status == \"Scheduled\":\n                #orange\n                statusColour = \"F2830C\"\n            elif status == \"In Progress\":\n                #yellow\n                statusColour = \"FCEA1C\"\n            elif status == \"Cancelled\":\n                #grey\n                statusColour = \"9C9B97\"    \n            else:\n                #white\n                statusColour = \"FFFFFF\"      \t\t\n            #add to combined worksheet\n            combinedWorksheet[\"A\"+str(x)].value = manager\n            combinedWorksheet[\"B\"+str(x)].value = workGroup\n            combinedWorksheet[\"C\"+str(x)].value = inspectionType\n            combinedWorksheet[\"D\"+str(x)].value = title\n            combinedWorksheet[\"E\"+str(x)].value = startDate\n            combinedWorksheet[\"F\"+str(x)].value = dueDate\n            combinedWorksheet[\"G\"+str(x)].value = owner\n            combinedWorksheet[\"H\"+str(x)].value = percentDone\n            combinedWorksheet[\"I\"+str(x)].value = status\n            combinedWorksheet[\"J\"+str(x)].value = cancellation\n            combinedWorksheet[\"I\"+str(x)].fill = PatternFill(start_color=statusColour, fill_type = \"solid\")\n            #add to specific sheet\n            formattedSheet1[\"A\"+str(y)].value = manager\n            formattedSheet1[\"B\"+str(y)].value = workGroup\n            formattedSheet1[\"C\"+str(y)].value = inspectionType\n            formattedSheet1[\"D\"+str(y)].value = title\n            formattedSheet1[\"E\"+str(y)].value = startDate\n            formattedSheet1[\"F\"+str(y)].value = dueDate\n            formattedSheet1[\"G\"+str(y)].value = owner\n            formattedSheet1[\"H\"+str(y)].value = percentDone\n            formattedSheet1[\"I\"+str(y)].value = status\n            formattedSheet1[\"J\"+str(y)].value = cancellation\n            formattedSheet1[\"I\"+str(y)].fill = PatternFill(start_color=statusColour, fill_type = \"solid\")\n            x = x + 1\n            y = y + 1\n    \n    if secondWorkbookName != \"\":\n        #extract second enablon report\n        #keep x the same value as we want to add to the end of the combined report\n        y = formattedStartingRow #reset to 2\n        for row in range(4,secondRowCount):\n            if secondWorksheet[\"Q\"+str(row)].value != None:\n                manager = secondWorksheet[\"Q\"+str(row)].value\n                workGroup = secondWorksheet[\"B\"+str(row)].value\n                inspectionType = secondWorksheet[\"E\"+str(row)].value\n                title = secondWorksheet[\"D\"+str(row)].value\n                startDate = secondWorksheet[\"F\"+str(row)].value\n                dueDate = secondWorksheet[\"G\"+str(row)].value\n                owner = secondWorksheet[\"H\"+str(row)].value\n                percentDone = secondWorksheet[\"L\"+str(row)].value\n                status = secondWorksheet[\"K\"+str(row)].value\n                cancellation = secondWorksheet[\"R\"+str(row)].value\n                if workGroup.find(\"OBSOLETE\") > 0:\n                    workGroup = workGroup.replace(\"OBSOLETE \", \"\")    \n                if status == \"Completed\":\n                    #green\n                    statusColour = \"21C452\"\n                elif status == \"Overdue\":\n                    #red\n                    statusColour = \"DE211B\"\n                elif status == \"Scheduled\":\n                    #orange\n                    statusColour = \"F2830C\"\n                elif status == \"In Progress\":\n                    #yellow\n                    statusColour = \"FCEA1C\"\n                elif status == \"Cancelled\":\n                    #grey\n                    statusColour = \"9C9B97\" \n                else:\n                    #white\n                    statusColour = \"FFFFFF\"    \t\t\t\n                #add to combined worksheet\n                combinedWorksheet[\"A\"+str(x)].value = manager\n                combinedWorksheet[\"B\"+str(x)].value = workGroup\n                combinedWorksheet[\"C\"+str(x)].value = inspectionType\n                combinedWorksheet[\"D\"+str(x)].value = title\n                combinedWorksheet[\"E\"+str(x)].value = startDate\n                combinedWorksheet[\"F\"+str(x)].value = dueDate\n                combinedWorksheet[\"G\"+str(x)].value = owner\n                combinedWorksheet[\"H\"+str(x)].value = percentDone\n                combinedWorksheet[\"I\"+str(x)].value = status\n                combinedWorksheet[\"J\"+str(x)].value = cancellation\n                combinedWorksheet[\"I\"+str(x)].fill = PatternFill(start_color=statusColour, fill_type = \"solid\")\n                #add to specific sheet\n                formattedSheet2[\"A\"+str(y)].value = manager\n                formattedSheet2[\"B\"+str(y)].value = workGroup\n                formattedSheet2[\"C\"+str(y)].value = inspectionType\n                formattedSheet2[\"D\"+str(y)].value = title\n                formattedSheet2[\"E\"+str(y)].value = startDate\n                formattedSheet2[\"F\"+str(y)].value = dueDate\n                formattedSheet2[\"G\"+str(y)].value = owner\n                formattedSheet2[\"H\"+str(y)].value = percentDone\n                formattedSheet2[\"I\"+str(y)].value = status\n                formattedSheet2[\"J\"+str(y)].value = cancellation\n                formattedSheet2[\"I\"+str(y)].fill = PatternFill(start_color=statusColour, fill_type = \"solid\")\n                x = x + 1\n                y = y + 1\n    formattedWorkbook.save(reportLocation+reportName)\n    runDate1 = datetime.now()\n    runDate = runDate1.strftime(\"%Y-%m-%d\")\n    newReportName = runDate +\" \"+reportName\n    newReport = reportLocation + newReportName\n    formattedWorkbook.save(newReport)\n    firstWorkbook.close()\n    if secondWorkbookName != \"\":\n        secondWorkbook.close()\n    formattedWorkbook.close()\n    \n    return{\"newReportName\":newReportName}"
  outputs:
    - newReportName
  results:
    - SUCCESS
