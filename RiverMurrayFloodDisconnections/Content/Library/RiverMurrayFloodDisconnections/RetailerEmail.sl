namespace: RiverMurrayFloodDisconnections
operation:
  name: RetailerEmail
  inputs:
    - accessToken
    - retailerEmailLog
  python_action:
    use_jython: false
    script: "def execute(accessToken,retailerEmailLog):\r\n    import requests\r\n    import json\r\n    import datetime\r\n    from openpyxl import load_workbook \r\n    import os\r\n    \r\n    workbook = load_workbook(filename=retailerEmailLog,read_only=True)\r\n    worksheet = workbook.active\r\n    rowCount = worksheet.max_row\r\n    \r\n    for row in range(1,rowCount):\r\n        retailerName = worksheet[\"A\"+str(row)].value\r\n        retailerEmail = worksheet[\"B\"+str(row)].value\r\n        textBody = worksheet[\"C\"+str(row)].value\r\n        if textBody != None:\r\n            textBody = textBody.replace(\"_x000D_\", \"\")\r\n            emailbody = \"Hi Team,\\n\\nThe below sites have been disconnected on the dates indicated below as part of the Murray River flood management process.\\n\\nWe encourage Retailers (prior to finalising the customer account within your systems) to contact their customer to determine how they would like to manage their ongoing Retailer contract (this disconnection is not based on a standard customer move out scenario).\\n\\nWe will provide updates on the required process for reconnection once flood water levels have abated.\\n\\nPlease Note: If there has been water damage of any kind, SA Power Networks will also require a eCoC on site, after electrical repairs are performed.\\n\\nNMI / Date of Disconnection / Address / Meter\\n\"+textBody+\"\\nKind Regards\\nSA Power Networks\"\r\n    \r\n            url = \"https://graph.microsoft.com/v1.0/users/B2B@sapowernetworks.com.au/sendMail\"\r\n            payload = \"{\\r\\n  \\\"message\\\": {\\r\\n    \\\"subject\\\": \\\"Flood Management Disconnections\\\",\\r\\n    \\\"body\\\": {\\r\\n      \\\"contentType\\\": \\\"Text\\\",\\r\\n      \\\"content\\\": \\\"\"+emailbody+\"\\\"\\r\\n    },\\r\\n    \\\"toRecipients\\\": [\\r\\n      {\\r\\n        \\\"emailAddress\\\": {\\r\\n          \\\"address\\\": \\\"\"+retailerEmail+\"\\\"\\r\\n        }\\r\\n      }\\r\\n    ]\\r\\n  },\\r\\n  \\\"saveToSentItems\\\": \\\"true\\\"\\r\\n}\"\r\n            headers = {\r\n                'Content-Type': 'application/json',\r\n                'SdkVersion': 'postman-graph/v1.0',\r\n                'Authorization': 'Bearer '+ accessToken\r\n            }\r\n            response = requests.request(\"POST\", url, headers=headers, data = payload)\r\n    workbook.close()"
  results:
    - SUCCESS
