namespace: RecloserAutomation
operation:
  name: sendEmail
  inputs:
    - rundate:
        required: false
  python_action:
    use_jython: false
    script: "def execute(rundate):\r\n    global pd, date, timedelta, wincom32Client, os, root, yesterday\r\n    import win32com.client as wincom32Client\r\n    import os\r\n    from datetime import date, timedelta, datetime\r\n    import pandas as pd\r\n    \r\n    root = \"C:/Users/svcrpabot/OneDrive - SA Power Networks/Recloser Patrol Automation/\"\r\n\r\n    if rundate != \"\":\r\n        yesterday = datetime.strptime(rundate, '%d/%m/%Y').date() - timedelta(1)\r\n    else:\r\n        yesterday = datetime.today().date() - timedelta(1)\r\n    \r\n    emailAddresses = [\"Julius.Bullas@sapowernetworks.com.au\", \"Daniel.Rohling@sapowernetworks.com.au\", \"Mohammad.Shafaie@sapowernetworks.com.au\"]\r\n    subject = f\"Reclose report for {yesterday}\"\r\n    filePath_ValidRecloses = f\"{root}Valid Reclose Output/validRecloses_{yesterday}.csv\"\r\n    filePath_ValidReclosesWithPastEvents = f\"{root}Valid Recloses With Past Events/ReclosesWithPastEvents_{yesterday}.xlsx\"\r\n    \r\n    recloseReport = pd.read_csv(filePath_ValidRecloses)\r\n    recloseReport = formatReport(recloseReport)\r\n    recloseReport_html = recloseReport.to_html()\r\n    \r\n    sendEmail(emailAddresses, subject, recloseReport_html, [filePath_ValidRecloses, filePath_ValidReclosesWithPastEvents])\r\n    \r\n# you can add additional helper methods below.\r\ndef formatReport(recloseReport):\r\n  # Drop Columns\r\n  columnsToDrop = ['Rainfall-2h (mm)', \r\n\t\t\t\t\t'Rainfall-1h (mm)',\r\n\t\t\t\t\t'Rainfall+0h (mm)',\r\n\t\t\t\t\t'Rainfall+1h (mm)',\r\n\t\t\t\t\t'Rainfall+2h (mm)',]\r\n  recloseReport = recloseReport.drop(columnsToDrop, axis = 1)\r\n\r\n  # Remove NaN\r\n  recloseReport = recloseReport.fillna(\"\")\r\n  return recloseReport\r\n\r\ndef sendEmail(emailAddresses, subject, HTMLbody, files):\r\n  iConf = wincom32Client.Dispatch(\"CDO.Configuration\")\r\n  Flds = iConf.Fields\r\n  Flds(\"http://schemas.microsoft.com/cdo/configuration/smtpserver\").Value = \"emanager\"\r\n  Flds(\"http://schemas.microsoft.com/cdo/configuration/smtpserverport\").Value = 25\r\n  Flds(\"http://schemas.microsoft.com/cdo/configuration/sendusing\").Value = 2 # cdoSendUsingPort\r\n  # Authentication and stuff\r\n  Flds('http://schemas.microsoft.com/cdo/configuration/smtpauthenticate').Value = 0 # No authentication\r\n  # The following fields are only used if the previous authentication value is set to 1 or 2\r\n  # Flds('http://schemas.microsoft.com/cdo/configuration/smtpaccountname').Value = \"user\"\r\n  # Flds('http://schemas.microsoft.com/cdo/configuration/sendusername').Value = \"domain\\\\user\"\r\n  # Flds('http://schemas.microsoft.com/cdo/configuration/sendpassword').Value = \"password\"\r\n  Flds.Update()\r\n  iMsg = wincom32Client.Dispatch(\"CDO.Message\")\r\n  iMsg.Configuration = iConf\r\n  iMsg.To = \";\".join(emailAddresses)\r\n  iMsg.From = \"Process_Automation@sapowernetworks.com.au\"\r\n  iMsg.Subject = subject\r\n  iMsg.HTMLBody = HTMLbody\r\n  # The following assumes the files to be in the current directory\r\n  for file in files:\r\n    iMsg.AddAttachment(file)\r\n  iMsg.Send()\r\n\r\n# Used for debugging offline\r\ndef set_yesterday(yesterdayIN):\r\n  global yesterday\r\n  yesterday = yesterdayIN\r\n  return"
  results:
    - SUCCESS
