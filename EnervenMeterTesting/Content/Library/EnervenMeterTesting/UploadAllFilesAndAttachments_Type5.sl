namespace: EnervenMeterTesting
operation:
  name: UploadAllFilesAndAttachments_Type5
  inputs:
    - accessToken
    - filePath
  python_action:
    use_jython: false
    script: "def execute(accessToken,filePath): \r\n    import requests\r\n    import os\r\n    from os import listdir\r\n    from os.path import isfile, join, isdir\r\n    import datetime\r\n    \r\n    today = datetime.datetime.now()\r\n    year = today.strftime(\"%Y\") \r\n    \r\n    failedSampleLot = \"\"\r\n    failedAttachments = \"\"\r\n    failedSummarySheet = \"\"\r\n\tfinalResult = \"\"\r\n    \r\n    #gets all files and directories in the location\r\n    onlyfiles = [f for f in listdir(filePath)]\r\n    \r\n    for file in onlyfiles:\r\n        #upload Sample Lots\r\n        if (\"Sample Lot\" in file and \"xlsx\" in file) or (\"Inspection Results\" in file and \"xlsx\" in file):\r\n            body = open(filePath + file, 'rb').read()\r\n            file = file.replace(\" \",\"%20\")\r\n            url = \"https://graph.microsoft.com/v1.0/drives/b!qLnxhp_SHUuAsdyx2DVZTU3MsDyQjVJIpIH-wKwcAy65QTGBahSSTpZ_Rt2cU8qw/root:/General/\"+year+\"/Type%205%20Test%20Results/\"+ file + \":/content\"\r\n            head = {\"Authorization\": \"Bearer \" + accessToken, \"Content-Type\": \"application/binary\"}\r\n            response = requests.put(url, data=body, headers=head)\r\n            responseCode = response.status_code\r\n            file = file.replace(\"%20\",\" \")\r\n            if responseCode >= 200 or responseCode < 300:\r\n                os.remove(filePath + file)\r\n\t\t\telse:\r\n\t\t\t\tfailedSampleLot = failedSampleLot + file + \" \"\r\n        elif isdir(filePath+file):\r\n            #if attachment folder\r\n            if \"Attachment\" in file:\r\n                onlyAttachments = [f for f in listdir(filePath+file) if isfile(join(filePath+file, f))]  \r\n                for attachment in onlyAttachments:\r\n                    os.remove(filePath+ file + \"/\" +  attachment) \r\n            #if summary sheet folder\r\n            elif \"Summary Sheet\" in file:\r\n                #get all summary sheets\r\n                onlySummarySheet = [f for f in listdir(filePath+file) if isfile(join(filePath+file, f))]  \r\n                #upload summary sheets\r\n                for sheet in onlySummarySheet:\r\n                    body = open(filePath + file + \"\" + \"/\" + sheet, 'rb').read()\r\n                    file = file.replace(\" \",\"%20\")\r\n\t\t\t\t\tsheet = sheet.replace(\" \",\"%20\")\r\n                    url = \"https://graph.microsoft.com/v1.0/drives/b!qLnxhp_SHUuAsdyx2DVZTU3MsDyQjVJIpIH-wKwcAy65QTGBahSSTpZ_Rt2cU8qw/root:/General/\"+year+\"/Type%205%20Test%20Results/\"+ file + \"/\" + sheet+\":/content\"\r\n                    head = {\"Authorization\": \"Bearer \" + accessToken, \"Content-Type\": \"application/binary\"}\r\n                    response = requests.put(url, data=body, headers=head)\r\n                    responseCode = response.status_code           \r\n                    file = file.replace(\"%20\",\" \") \r\n                    sheet = sheet.replace(\"%20\",\" \") \r\n                    if responseCode >= 200 or responseCode < 300:\r\n                        os.remove(filePath+ file + \"/\" +  sheet) \r\n                    else:\r\n                        failedSummarySheet = failedSummarySheet + sheet + \" \"\r\n            if len(os.listdir(filePath+ file)) == 0:\r\n                os.rmdir(filePath+ file)                           \r\n\r\n    if failedSampleLot != \"\" or failedAttachments != \"\" or failedSummarySheet != \"\":\r\n        finalResult = \"failed\"\r\n\t\t\r\n    return{\"failedSampleLot\":failedSampleLot,\"failedAttachments\":failedAttachments,\"failedSummarySheet\":failedSummarySheet,\"finalResult\":finalResult}"
  outputs:
    - failedSampleLot
    - failedAttachments
    - failedSummarySheet
    - finalResult
  results:
    - FAILURE: '${finalResult == "failed"}'
    - SUCCESS
