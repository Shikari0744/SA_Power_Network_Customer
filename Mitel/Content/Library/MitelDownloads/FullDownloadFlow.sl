namespace: MitelDownloads
operation:
  name: FullDownloadFlow
  inputs:
    - bNumber
    - rowCount
  python_action:
    use_jython: false
    script: "def execute(bNumber, rowCount): \r\n    from openpyxl import load_workbook\r\n    import requests\r\n    from datetime import datetime\r\n    workbookMain = load_workbook(filename=\"C:/temp/Book\"+bNumber+\".xlsx\",read_only=False)\r\n    sheetMain = workbookMain.active\r\n    \r\n    for x in range(1,int(rowCount)):\r\n        start = sheetMain[\"A\"+str(x)].value\r\n        duration = sheetMain[\"B\"+str(x)].value\r\n        direction = sheetMain[\"C\"+str(x)].value\r\n        outside_name = sheetMain[\"E\"+str(x)].value\r\n        outside_number = sheetMain[\"F\"+str(x)].value\r\n        extension = sheetMain[\"G\"+str(x)].value\r\n        ref_id = sheetMain[\"I\"+str(x)].value\r\n        callrecord_id = sheetMain[\"M\"+str(x)].value\r\n        completed = sheetMain[\"W\"+str(x)].value\r\n        \r\n        if start != \"Start\":\r\n            dateOfRecording = start.strftime(\"%Y-%m-%d %H.%M\")\r\n            yearOfRecording = start.strftime(\"%Y\")\r\n            folderLoc = start.strftime(\"%Y-%m-%d\")\r\n            indexLoc = start.strftime(\"%Y-%m\")\r\n        else:\r\n            continue\r\n        \r\n        if completed != \"YES\":\r\n            #get session ID\r\n            url = \"http://10.209.10.116/TracerWebServices/SESSION.ASMX\"\r\n            payload = \"<soapenv:Envelope xmlns:soapenv=\\\"http://schemas.xmlsoap.org/soap/envelope/\\\" xmlns:tem=\\\"http://tempuri.org/\\\">\\r\\n   <soapenv:Header/>\\r\\n   <soapenv:Body>\\r\\n      <tem:Login>\\r\\n         <!--Optional:-->\\r\\n         <tem:loginClass>a</tem:loginClass>\\r\\n         <!--Optional:-->\\r\\n         <tem:username>markf</tem:username>\\r\\n         <!--Optional:-->\\r\\n         <tem:password>markf</tem:password>\\r\\n      </tem:Login>\\r\\n   </soapenv:Body>\\r\\n</soapenv:Envelope>\"\r\n            headers = {'Content-Type': 'text/xml;charset=UTF-8','SOAPAction': '\"http://tempuri.org/Login\"'}\r\n            response = requests.request(\"POST\", url, headers=headers, data = payload)\r\n            response = response.text\r\n            def find_between(response, first, last):\r\n                try:\r\n                    start = response.index(first) + len(first)\r\n                    end = response.index(last, start)\r\n                    return response[start:end]\r\n                except ValueError: []\r\n                return \"\"\r\n            sessionID = find_between(response, \"<LoginResult>\", \"</LoginResult>\")\r\n        \r\n            #get mp3\r\n            url = \"http://10.209.10.116/TracerWebServices/Playback.ashx?SessionID=\"+ sessionID +\"&CallGuid=\"+ref_id+\"&MediaType=Voice&MediaID=1&AudioFormat=MP3\"\r\n            payload = {}\r\n            headers= {}\r\n            response = requests.request(\"GET\", url, headers=headers, data = payload)\r\n            response1 = response.text.encode('utf8')\r\n            content = response.content\r\n            with open(r'C:/temp/Mitel/'+yearOfRecording+'/'+ folderLoc + '/' + dateOfRecording + \" - \" + ref_id +'.mp3', 'ab') as file:\r\n                file.write(response.content)\r\n                file.flush()\r\n                \r\n            if response.status_code == 200:\r\n                #write to log file \r\n                currentDate = datetime.today()\r\n                currentDate = str(currentDate)\r\n                log = open(\"C:/temp/MitelLogFile\"+bNumber+\".txt\",\"a\")\r\n                log.write(str(response.status_code)+ \" \" + str(x) + \" \" + currentDate + \",\\n\")\r\n                \r\n                #mark row as complete\r\n                sheetMain[\"W\"+str(x)] = \"YES\"\r\n                \r\n                #REMOVING INDEX AS BEING RUN SEPARATELY\r\n                #update index\r\n                #workbookIndex = load_workbook(filename=\"C:/temp/Mitel/index\" +indexLoc+\".xlsx\",read_only=False)\r\n                #sheetIndex = workbookIndex.active\r\n                #sheetIndex[\"A\"+str(x)] = dateOfRecording\r\n                #sheetIndex[\"B\"+str(x)] = duration\r\n                #sheetIndex[\"C\"+str(x)] = extension\r\n                #sheetIndex[\"D\"+str(x)] = outside_number\r\n                #sheetIndex[\"E\"+str(x)] = direction\r\n                #sheetIndex[\"F\"+str(x)] = extension\r\n                #sheetIndex[\"G\"+str(x)] = extension\r\n                #sheetIndex[\"H\"+str(x)] = outside_number\r\n                #sheetIndex[\"I\"+str(x)] = \"/Mitel/\"+yearOfRecording+\"/\"+folderLoc+\"/\"+dateOfRecording + \" - \" + ref_id +\".mp3\"\r\n                #workbookIndex.save(\"C:/temp/Mitel/index\" +indexLoc+\".xlsx\")\r\n            else:\r\n                #write to log file \r\n                log = open(\"C:/temp/MitelLogFileFailed\"+bNumber+\".txt\",\"a\")\r\n                log.write(str(response.status_code)+ \" \" + str(x) + \" \" + currentDate + \",\\n\")\r\n        else:\r\n            continue\r\n\r\n    workbookMain.save(\"C:/temp/Book\"+bNumber+\".xlsx\")"
  outputs:
    - start
  results:
    - SUCCESS
